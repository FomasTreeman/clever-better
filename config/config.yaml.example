# Clever Better Configuration Template
# Copy this file to config.yaml and fill in your values
# NEVER commit config.yaml with real credentials
#
# Configuration loading priority:
# 1. Hardcoded defaults (in LoadWithDefaults)
# 2. Configuration file (config/config.yaml) with ${VAR} placeholder expansion
# 3. Environment variables (CLEVER_BETTER_*)
# 4. AWS Secrets Manager (if AWS_SECRETS_ENABLED=true)
#
# Environment Variable Placeholders:
# - Use ${VAR_NAME} syntax in this file to expand shell environment variables
# - Example: password: ${DB_PASSWORD} â†’ expands to the value of $DB_PASSWORD
# - If variable not set, placeholder remains literal: ${UNSET_VAR}
# - Expansion happens before validation and before AWS Secrets Manager overlay
#
# Environment Variable Mapping:
# - Field paths use dots (database.host)
# - Environment variables use underscores and uppercase (CLEVER_BETTER_DATABASE_HOST)
# - Prefix all variables with CLEVER_BETTER_
# - These override both YAML values and placeholder expansions
#
# AWS Secrets Manager:
# - Set AWS_SECRETS_ENABLED=true to enable
# - Set AWS_REGION and AWS_SECRET_NAME environment variables
# - Supports: database_password, betfair_app_key, betfair_username, betfair_password, racing_post_api_key
#
# For more information, see docs/CONFIGURATION.md

# =============================================================================
# Application Settings
# =============================================================================
app:
  name: clever-better
  environment: development  # development, staging, production
  log_level: info          # debug, info, warn, error
  rate_limit:
    requests_per_second: 50
    burst_size: 100
  scheduler:
    historical_sync_enabled: true
    historical_sync_cron_expression: "0 2 * * *"  # Daily at 2 AM UTC
    live_polling_enabled: true
    live_polling_interval_seconds: 5

# =============================================================================
# Database Configuration
# =============================================================================
database:
  host: localhost
  port: 5432
  name: clever_better
  user: postgres
  password: ${DB_PASSWORD}  # Set via environment variable or AWS Secrets Manager
  ssl_mode: disable         # disable, require, verify-full (require SSL in production)
  max_connections: 25
  max_idle_connections: 5
  connection_max_lifetime: 5m
  statement_cache_mode: describe  # disable, describe, prepare (for parameterized queries)

# =============================================================================
# Data Sources Configuration
# =============================================================================
data_sources:
  betfair:
    enabled: true
    base_url: https://api.betfair.com
    auth:
      api_key: ${BETFAIR_APP_KEY}
      session_token: ${BETFAIR_SESSION_TOKEN}
      username: ${BETFAIR_USERNAME}
      password: ${BETFAIR_PASSWORD}
      cert_file: ${BETFAIR_CERT_FILE}
      key_file: ${BETFAIR_KEY_FILE}
    rate_limit:
      requests_per_second: 30
      burst_size: 50
    data_path: ./data/betfair/

  racing_post:
    enabled: false
    base_url: https://www.racingpost.com/api
    auth:
      api_key: ${RACING_POST_API_KEY}
    rate_limit:
      requests_per_second: 10
      burst_size: 20
    data_path: ./data/racing_post/

  csv:
    enabled: false
    data_path: ./data/csv/
    rate_limit:
      requests_per_second: 50
      burst_size: 100

# =============================================================================
# AWS Configuration (Optional)
# =============================================================================
aws:
  region: us-east-1
  secrets_enabled: false
  secret_name: clever-better/secrets  # Name in AWS Secrets Manager

# =============================================================================
# Betfair API Configuration
# =============================================================================
betfair:
  # Certificate authentication
  certificate:
    certPath: ${BETFAIR_CERT_PATH}  # Path to client certificate (PEM format)
    # Certificate is automatically reloaded on login attempts
  
  # API Configuration
  api:
    appKey: ${BETFAIR_APP_KEY}
    username: ${BETFAIR_USERNAME}
    baseUrl: "https://api.betfair.com/exchange/betting/json-rpc/v1/"
    requestTimeout: "30s"
    
    # Rate limiting (requests per second)
    rateLimit: 50
    
    # Retry configuration
    maxRetries: 3
    retryBackoff: "100ms"
  
  # Streaming Configuration
  stream:
    url: "stream-api.betfair.com:443"
    heartbeatMs: 5000
    conflateMs: 1000  # Conflate updates to 1 second
    
    # Reconnection settings
    maxReconnectAttempts: 10
    initialReconnectDelay: "1s"
    maxReconnectDelay: "30s"
  
  # Market Data Collection
  marketData:
    # Buffer settings for batch inserts
    bufferSize: 1000
    flushIntervalSeconds: 5
    
    # Market collection settings
    eventTypeId: 4339  # Greyhound racing
    marketTypes:
      - WIN
      - PLACE
    
    # Time range for market queries
    inPlayDelay: "2m"
    marketWindow: "7d"
  
  # Betting Configuration
  betting:
    # Stake limits
    minStake: 0.50
    maxStake: 500.00
    defaultOrderType: "LAPSE"  # LAPSE, PERSIST, or EXECUTE_LAPSE
    
    # Commission (percentage)
    commission: 5.0
    
    # Order monitoring
    pollIntervalSeconds: 30
    maxOrderAge: "24h"
  
  # Error Handling
  errorHandling:
    # Log level for API errors
    logLevel: "INFO"
    
    # Maximum errors before circuit breaker opens
    circuitBreakerThreshold: 10
    circuitBreakerTimeout: "30s"

# =============================================================================
# ML Service Configuration
# =============================================================================
ml_service:
  url: http://localhost:8000
  grpc_address: localhost:50051
  timeout_seconds: 30
  retry_attempts: 3

# =============================================================================
# Trading Configuration
# =============================================================================
trading:
  # Risk Management
  max_stake_per_bet: 10.00
  max_daily_loss: 100.00
  max_exposure: 500.00

  # Strategy Settings
  min_confidence_threshold: 0.65
  min_expected_value: 0.02

  # Market Selection
  markets:
    - WIN
    - PLACE

  # Time Settings
  pre_race_window_minutes: 30
  min_time_to_start_seconds: 60

# =============================================================================
# Backtesting Configuration
# =============================================================================
backtest:
  start_date: "2023-01-01"
  end_date: "2024-01-01"
  initial_bankroll: 1000.00
  monte_carlo_iterations: 1000
  walk_forward_windows: 12
  commission_rate: 0.05
  slippage_ticks: 1
  min_liquidity: 5.0
  output_path: "./output/backtest_results.json"
  ml_export_enabled: false
  risk_free_rate: 0.0

# =============================================================================
# Data Ingestion Configuration
# =============================================================================
data_ingestion:
  # Data Sources
  sources:
    - name: betfair_historical
      enabled: true
      batch_size: 1000
    - name: racing_post
      enabled: false
      api_key: ${RACING_POST_API_KEY}  # Set via environment variable or AWS Secrets Manager

  # Schedule
  schedule:
    historical_sync: "0 2 * * *"  # Daily at 2 AM (cron format)
    live_polling_interval_seconds: 5

# =============================================================================
# Metrics and Monitoring
# =============================================================================
metrics:
  enabled: true
  port: 9090
  path: /metrics

# =============================================================================
# Feature Flags
# =============================================================================
features:
  live_trading_enabled: false
  paper_trading_enabled: true
  ml_predictions_enabled: true
  advanced_analytics_enabled: false
